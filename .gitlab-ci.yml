stages:
  - build
  - deploy

fedora-gcc-x86_64:
  stage: build
  image: fedora:rawhide
  except:
    - tags
  before_script:
    - dnf install -y autoconf autoconf-archive automake bison dbus-x11 flex gcc git glib2-devel graphviz-devel lcov libxslt make vala
  script:
    - git fetch --tags
    - ./autogen.sh --enable-coverage
    - make -j4
    - make -j4 coverage-report
  artifacts:
    name: "vala-${CI_JOB_NAME}-${CI_COMMIT_REF_NAME}"
    paths:
      - "coverage"
    expire_in: 1 week

ubuntu-clang-x86_64:
  stage: build
  image: ubuntu:devel
  except:
    - tags
  variables:
    CC: clang
  before_script:
    - apt install -y automake autoconf-archive bison dbus flex clang git libglib2.0-dev libgraphviz-dev lcov xsltproc make valac
  script:
    - git fetch --tags
    - ./autogen.sh
    - make -j4
    - make -j4 bootstrap
    - make -j4 check

pages:
  stage: deploy
#  only:
#    - master
  script:
    - mv coverage/ public/
  artifacts:
    name: "vala-${CI_JOB_NAME}-${CI_COMMIT_REF_NAME}"
    paths:
      - public
    expire_in: 1 week
