image: fedora:rawhide

stages:
  - build
  - deploy

fedora-x86_64:
  stage: build
  except:
    - tags
  before_script:
    - dnf install -y autoconf autoconf-archive automake bison dbus-x11 flex gcc glib2-devel graphviz-devel lcov libxslt make vala
  script:
    - git fetch --tags
    - ./autogen.sh --enable-coverage
    - make -j8
    - make -j8 check
    - make -j8 coverage-report
  artifacts:
    name: "vala-${CI_JOB_NAME}-${CI_COMMIT_REF_NAME}"
    when: always
    paths:
      - "coverage"

pages:
  stage: deploy
#  only:
#    - master
  script:
    - mv coverage/ public/
  cache:
    key: ${CI_COMMIT_REF_SLUG}
  artifacts:
    paths:
      - public
    expire_in: 1 week
